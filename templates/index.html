<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>比赛信息爬虫管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        .status-idle { color: #6c757d; }
        .status-running { color: #0d6efd; }
        .status-completed { color: #198754; }
        .status-error { color: #dc3545; }
        
        .platform-card {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }
        
        .platform-card.running {
            border-left-color: #0d6efd;
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.2);
        }
        
        .platform-card.completed {
            border-left-color: #198754;
        }
        
        .platform-card.error {
            border-left-color: #dc3545;
        }
        
        .system-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .log-viewer {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-robot"></i> 比赛信息爬虫管理系统
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="current-time"></span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 系统状态卡片 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card system-info">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h5><i class="bi bi-cpu"></i> CPU使用率</h5>
                                <h3 id="cpu-usage">0%</h3>
                            </div>
                            <div class="col-md-3">
                                <h5><i class="bi bi-memory"></i> 内存使用率</h5>
                                <h3 id="memory-usage">0%</h3>
                            </div>
                            <div class="col-md-3">
                                <h5><i class="bi bi-hdd"></i> 磁盘使用率</h5>
                                <h3 id="disk-usage">0%</h3>
                            </div>
                            <div class="col-md-3">
                                <h5><i class="bi bi-clock"></i> 运行任务</h5>
                                <h3 id="running-tasks">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速操作按钮 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> 快速操作</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success me-2" onclick="runAllTasks()">
                            <i class="bi bi-play-circle"></i> 运行所有爬虫
                        </button>
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#filteredCrawlModal">
                            <i class="bi bi-funnel"></i> 筛选爬取
                        </button>
                        <button class="btn btn-info me-2" onclick="refreshStatus()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新状态
                        </button>
                        <button class="btn btn-outline-primary me-2" onclick="loadAllCompetitions()">
                            <i class="bi bi-list-ul"></i> 显示所有比赛
                        </button>
                        <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                            <i class="bi bi-calendar-plus"></i> 添加定时任务
                        </button>
                        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#logModal">
                            <i class="bi bi-file-text"></i> 查看日志
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 爬虫平台管理面板 -->
        <div class="row">
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card platform-card" id="card-baidu">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-search"></i> 百度AI Studio</h6>
                        <span class="badge bg-secondary" id="status-baidu">空闲</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="message-baidu">等待执行</p>
                        <p class="text-muted small" id="lastrun-baidu">上次运行: 从未</p>
                        <button class="btn btn-primary btn-sm" onclick="runTask('baidu')" id="btn-baidu">
                            <i class="bi bi-play"></i> 运行
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card platform-card" id="card-aliyun">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-cloud"></i> 阿里天池</h6>
                        <span class="badge bg-secondary" id="status-aliyun">空闲</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="message-aliyun">等待执行</p>
                        <p class="text-muted small" id="lastrun-aliyun">上次运行: 从未</p>
                        <button class="btn btn-primary btn-sm" onclick="runTask('aliyun')" id="btn-aliyun">
                            <i class="bi bi-play"></i> 运行
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card platform-card" id="card-tencent">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-code-square"></i> 腾讯CSDN</h6>
                        <span class="badge bg-secondary" id="status-tencent">空闲</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="message-tencent">等待执行</p>
                        <p class="text-muted small" id="lastrun-tencent">上次运行: 从未</p>
                        <button class="btn btn-primary btn-sm" onclick="runTask('tencent')" id="btn-tencent">
                            <i class="bi bi-play"></i> 运行
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card platform-card" id="card-wechat">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-chat-dots"></i> 微信公众号</h6>
                        <span class="badge bg-secondary" id="status-wechat">空闲</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="message-wechat">等待执行</p>
                        <p class="text-muted small" id="lastrun-wechat">上次运行: 从未</p>
                        <button class="btn btn-primary btn-sm" onclick="runTask('wechat')" id="btn-wechat">
                            <i class="bi bi-play"></i> 运行
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card platform-card" id="card-update_status">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-arrow-repeat"></i> 状态更新</h6>
                        <span class="badge bg-secondary" id="status-update_status">空闲</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="message-update_status">等待执行</p>
                        <p class="text-muted small" id="lastrun-update_status">上次运行: 从未</p>
                        <button class="btn btn-primary btn-sm" onclick="runTask('update_status')" id="btn-update_status">
                            <i class="bi bi-play"></i> 运行
                        </button>
                    </div>
                </div>
            </div>

            <!-- 定时任务列表 -->
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-calendar-check"></i> 定时任务</h6>
                    </div>
                    <div class="card-body">
                        <div id="scheduled-jobs">
                            <p class="text-muted">暂无定时任务</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 比赛列表显示区域 -->
        <div class="row mt-4" id="competitions-section" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-trophy"></i> 比赛列表</h5>
                        <div>
                            <span class="badge bg-info" id="competitions-count">0</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="hideCompetitions()">
                                <i class="bi bi-x"></i> 隐藏
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>比赛名称</th>
                                        <th>平台</th>
                                        <th>状态</th>
                                        <th>开始时间</th>
                                        <th>结束时间</th>
                                        <th>难度</th>
                                        <th>类型</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="competitions-table">
                                    <!-- 比赛数据将在这里动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 定时任务模态框 -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加定时任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <div class="mb-3">
                            <label for="taskName" class="form-label">任务名称</label>
                            <input type="text" class="form-control" id="taskName" placeholder="例如：每日爬取任务" required>
                        </div>
                        <div class="mb-3">
                            <label for="frequency" class="form-label">执行频率</label>
                            <select class="form-select" id="frequency" onchange="updateScheduleOptions()" required>
                                <option value="daily">每天</option>
                                <option value="weekly">每周</option>
                                <option value="monthly">每月</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="executeTime" class="form-label">执行时间</label>
                            <input type="time" class="form-control" id="executeTime" value="09:00" required>
                        </div>
                        <div class="mb-3" id="weekdayOption" style="display: none;">
                            <label for="weekday" class="form-label">星期几</label>
                            <select class="form-select" id="weekday">
                                <option value="0">星期一</option>
                                <option value="1">星期二</option>
                                <option value="2">星期三</option>
                                <option value="3">星期四</option>
                                <option value="4">星期五</option>
                                <option value="5">星期六</option>
                                <option value="6">星期日</option>
                            </select>
                        </div>
                        <div class="mb-3" id="monthdayOption" style="display: none;">
                            <label for="monthday" class="form-label">每月第几天</label>
                            <input type="number" class="form-control" id="monthday" min="1" max="31" value="1">
                            <div class="form-text">输入1-31之间的数字</div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 定时任务将自动运行所有爬虫平台的数据采集。
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addSchedule()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选爬取模态框 -->
    <div class="modal fade" id="filteredCrawlModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">筛选爬取未结束的比赛</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="filteredCrawlForm">
                        <div class="mb-3">
                            <label for="filterDate" class="form-label">今天日期</label>
                            <input type="date" class="form-control" id="filterDate" required>
                            <div class="form-text">将爬取在此日期之后结束的比赛</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">选择爬取平台</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="baidu" id="platform-baidu" checked>
                                <label class="form-check-label" for="platform-baidu">百度AI Studio</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="aliyun" id="platform-aliyun" checked>
                                <label class="form-check-label" for="platform-aliyun">阿里天池</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="tencent" id="platform-tencent" checked>
                                <label class="form-check-label" for="platform-tencent">腾讯CSDN</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="wechat" id="platform-wechat">
                                <label class="form-check-label" for="platform-wechat">微信公众号</label>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 确认要开始筛选爬取吗？这将只爬取在指定日期之后结束的比赛。
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="startFilteredCrawl()">开始筛选爬取</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志查看模态框 -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">日志查看</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <select class="form-select" id="logFileSelect" onchange="loadLogContent()">
                            <option value="">选择日志文件</option>
                        </select>
                    </div>
                    <div class="log-viewer" id="logContent">
                        <p class="text-muted">请选择日志文件</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket连接
        const socket = io();
        
        // 更新当前时间
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }
        
        // 更新任务状态
        function updateTaskStatus(taskStatus) {
            const platforms = ['baidu', 'aliyun', 'tencent', 'wechat', 'update_status'];
            let runningCount = 0;
            
            platforms.forEach(platform => {
                const status = taskStatus[platform];
                const statusElement = document.getElementById(`status-${platform}`);
                const messageElement = document.getElementById(`message-${platform}`);
                const lastRunElement = document.getElementById(`lastrun-${platform}`);
                const buttonElement = document.getElementById(`btn-${platform}`);
                const cardElement = document.getElementById(`card-${platform}`);
                
                // 更新状态显示
                statusElement.textContent = getStatusText(status.status);
                statusElement.className = `badge bg-${getStatusColor(status.status)}`;
                
                // 更新消息
                messageElement.textContent = status.message || '等待执行';
                
                // 更新上次运行时间
                lastRunElement.textContent = `上次运行: ${status.last_run || '从未'}`;
                
                // 更新按钮状态
                if (status.status === 'running') {
                    buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>运行中';
                    buttonElement.disabled = true;
                    runningCount++;
                } else {
                    buttonElement.innerHTML = '<i class="bi bi-play"></i> 运行';
                    buttonElement.disabled = false;
                }
                
                // 更新卡片样式
                cardElement.className = `card platform-card ${status.status}`;
            });
            
            document.getElementById('running-tasks').textContent = runningCount;
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'idle': '空闲',
                'running': '运行中',
                'completed': '已完成',
                'error': '错误'
            };
            return statusMap[status] || status;
        }
        
        // 获取状态颜色
        function getStatusColor(status) {
            const colorMap = {
                'idle': 'secondary',
                'running': 'primary',
                'completed': 'success',
                'error': 'danger'
            };
            return colorMap[status] || 'secondary';
        }
        
        // 运行单个任务
        function runTask(platform) {
            // 平台名称映射
            const platformNames = {
                'baidu': '百度AI Studio',
                'aliyun': '阿里云天池',
                'tencent': '腾讯CSDN',
                'wechat': '微信公众号'
            };
            
            const platformName = platformNames[platform] || platform;
            const confirmMessage = `确认要运行${platformName}爬虫吗？\n\n此操作将爬取该平台的比赛信息并导入到飞书表格中。`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            fetch(`/api/run/${platform}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', '请求失败: ' + error.message);
            });
        }
        
        // 运行所有任务
        function runAllTasks() {
            // 显示确认对话框
            const confirmMessage = '确认要运行所有爬虫吗？\n\n此操作将依次执行：\n• 百度AI Studio爬虫\n• 阿里云天池爬虫\n• 腾讯CSDN爬虫\n• 微信公众号爬虫\n\n爬取过程可能需要较长时间，请耐心等待。';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            fetch('/api/run/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', '请求失败: ' + error.message);
            });
        }
        
        // 刷新状态
        function refreshStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                updateTaskStatus(data.task_status);
                updateSystemInfo(data.system_info);
                updateScheduledJobs(data.scheduled_jobs);
            })
            .catch(error => {
                showAlert('danger', '刷新状态失败: ' + error.message);
            });
        }
        
        // 更新系统信息
        function updateSystemInfo(systemInfo) {
            document.getElementById('cpu-usage').textContent = systemInfo.cpu_percent.toFixed(1) + '%';
            document.getElementById('memory-usage').textContent = systemInfo.memory_percent.toFixed(1) + '%';
            document.getElementById('disk-usage').textContent = systemInfo.disk_percent.toFixed(1) + '%';
        }
        
        // 更新定时任务列表
        function updateScheduledJobs(jobs) {
            const container = document.getElementById('scheduled-jobs');
            if (jobs.length === 0) {
                container.innerHTML = '<p class="text-muted">暂无定时任务</p>';
            } else {
                container.innerHTML = jobs.map(job => 
                    `<div class="d-flex justify-content-between align-items-center mb-2">
                        <small>${job}</small>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeSchedule('${job}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>`
                ).join('');
            }
        }
        
        // 更新定时任务选项显示
        function updateScheduleOptions() {
            const frequency = document.getElementById('frequency').value;
            const weekdayOption = document.getElementById('weekdayOption');
            const monthdayOption = document.getElementById('monthdayOption');
            
            // 隐藏所有选项
            weekdayOption.style.display = 'none';
            monthdayOption.style.display = 'none';
            
            // 根据频率显示相应选项
            if (frequency === 'weekly') {
                weekdayOption.style.display = 'block';
            } else if (frequency === 'monthly') {
                monthdayOption.style.display = 'block';
            }
        }
        
        // 添加定时任务
        function addSchedule() {
            const taskName = document.getElementById('taskName').value;
            const frequency = document.getElementById('frequency').value;
            const executeTime = document.getElementById('executeTime').value;
            const weekday = document.getElementById('weekday').value;
            const monthday = document.getElementById('monthday').value;
            
            if (!taskName || !frequency || !executeTime) {
                showAlert('warning', '请填写所有必填字段');
                return;
            }
            
            const scheduleData = {
                taskName: taskName,
                frequency: frequency,
                executeTime: executeTime
            };
            
            if (frequency === 'weekly') {
                scheduleData.weekday = parseInt(weekday);
            } else if (frequency === 'monthly') {
                scheduleData.monthday = parseInt(monthday);
            }
            
            fetch('/api/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    document.getElementById('scheduleForm').reset();
                    document.getElementById('executeTime').value = '09:00'; // 重置默认时间
                    updateScheduleOptions(); // 重置选项显示
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                    refreshStatus();
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', '添加定时任务失败: ' + error.message);
            });
        }
        
        // 删除定时任务
        function removeSchedule(jobId) {
            if (!confirm('确定要删除这个定时任务吗？')) {
                return;
            }
            
            fetch(`/api/schedule/${jobId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    refreshStatus();
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', '删除定时任务失败: ' + error.message);
            });
        }
        
        // 加载日志文件列表
        function loadLogFiles() {
            fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('logFileSelect');
                select.innerHTML = '<option value="">选择日志文件</option>';
                data.logs.forEach(log => {
                    const option = document.createElement('option');
                    option.value = log.name;
                    option.textContent = `${log.name} (${(log.size / 1024).toFixed(1)}KB, ${log.modified})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                showAlert('danger', '加载日志文件失败: ' + error.message);
            });
        }
        
        // 加载日志内容
        function loadLogContent() {
            const filename = document.getElementById('logFileSelect').value;
            if (!filename) {
                document.getElementById('logContent').innerHTML = '<p class="text-muted">请选择日志文件</p>';
                return;
            }
            
            fetch(`/api/logs/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('logContent').innerHTML = `<pre>${data.content}</pre>`;
                } else {
                    document.getElementById('logContent').innerHTML = `<p class="text-danger">${data.message}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('logContent').innerHTML = `<p class="text-danger">加载日志内容失败: ${error.message}</p>`;
            });
        }
        
        // 显示提示信息
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
        
        // 加载所有比赛数据
        function loadAllCompetitions() {
            fetch('/api/competitions')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCompetitions(data.data);
                    document.getElementById('competitions-count').textContent = data.total;
                    document.getElementById('competitions-section').style.display = 'block';
                    showAlert('success', `成功加载 ${data.total} 个比赛`);
                } else {
                    showAlert('danger', '加载比赛数据失败: ' + data.message);
                }
            })
            .catch(error => {
                showAlert('danger', '加载比赛数据失败: ' + error.message);
            });
        }
        
        // 显示比赛数据
        function displayCompetitions(competitions) {
            const tbody = document.getElementById('competitions-table');
            tbody.innerHTML = '';
            
            competitions.forEach(comp => {
                const row = document.createElement('tr');
                
                // 处理链接显示
                const linkHtml = comp.link ? `<a href="${comp.link}" target="_blank" class="text-decoration-none">${comp.name}</a>` : comp.name;
                
                // 处理状态显示
                const statusClass = comp.status === '进行中' ? 'success' : comp.status === '已结束' ? 'secondary' : 'primary';
                const statusHtml = `<span class="badge bg-${statusClass}">${comp.status || '未知'}</span>`;
                
                // 处理难度和类型显示
                const difficulty = Array.isArray(comp.difficulty) ? comp.difficulty.join(', ') : comp.difficulty || '';
                const type = Array.isArray(comp.type) ? comp.type.join(', ') : comp.type || '';
                
                row.innerHTML = `
                    <td>${linkHtml}</td>
                    <td><span class="badge bg-info">${comp.platform || ''}</span></td>
                    <td>${statusHtml}</td>
                    <td>${comp.start_date || ''}</td>
                    <td>${comp.end_date || ''}</td>
                    <td>${difficulty}</td>
                    <td>${type}</td>
                    <td>
                        ${comp.link ? `<a href="${comp.link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i></a>` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // 隐藏比赛列表
        function hideCompetitions() {
            document.getElementById('competitions-section').style.display = 'none';
        }
        
        // 开始筛选爬取
        function startFilteredCrawl() {
            const filterDate = document.getElementById('filterDate').value;
            if (!filterDate) {
                showAlert('warning', '请选择筛选日期');
                return;
            }
            
            const platforms = [];
            const checkboxes = document.querySelectorAll('#filteredCrawlForm input[type="checkbox"]:checked');
            checkboxes.forEach(cb => platforms.push(cb.value));
            
            if (platforms.length === 0) {
                showAlert('warning', '请至少选择一个爬取平台');
                return;
            }
            
            // 显示确认对话框
            const platformNames = {
                'baidu': '百度AI Studio',
                'aliyun': '阿里云天池',
                'tencent': '腾讯CSDN',
                'wechat': '微信公众号'
            };
            
            const selectedPlatformNames = platforms.map(p => platformNames[p] || p).join('、');
            const confirmMessage = `确认要开始筛选爬取吗？\n\n筛选日期：${filterDate}\n爬取平台：${selectedPlatformNames}\n\n此操作将爬取在指定日期之后结束的比赛（未结束的比赛）。`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // 发送筛选爬取请求
            fetch('/api/run/filtered', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    platforms: platforms,
                    date: filterDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('filteredCrawlModal'));
                    modal.hide();
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', '启动筛选爬取失败: ' + error.message);
            });
        }
        
        // WebSocket事件处理
        socket.on('task_status_update', function(data) {
            updateTaskStatus(data);
        });
        
        // 监听比赛数据更新
        socket.on('competitions_updated', function(data) {
            if (document.getElementById('competitions-section').style.display !== 'none') {
                displayCompetitions(data);
                document.getElementById('competitions-count').textContent = data.length;
                showAlert('info', '比赛数据已更新');
            }
        });
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            refreshStatus();
            
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            
            // 日志模态框打开时加载日志文件列表
            document.getElementById('logModal').addEventListener('show.bs.modal', function() {
                loadLogFiles();
            });
        });
    </script>
</body>
</html>