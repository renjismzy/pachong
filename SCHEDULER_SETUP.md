# 定时任务配置指南

本文档介绍如何设置每天早上9点自动爬取所有平台比赛信息的定时任务。

## 📋 文件说明

### 核心文件
- `scheduler.py` - 定时任务调度器主程序
- `run_crawler.bat` - Windows批处理文件（交互模式）
- `run_crawler_silent.bat` - Windows批处理文件（静默模式，推荐用于任务计划程序）

### 日志文件
- `logs/scheduler_YYYYMM.log` - 定时任务详细日志
- `logs/task_scheduler.log` - 任务计划程序执行日志

## 🚀 快速开始

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 测试运行
```bash
# 立即执行一次爬虫任务（测试）
python scheduler.py --mode once

# 启动定时调度器（每天9点执行）
python scheduler.py --mode schedule
```

## ⚙️ Windows任务计划程序配置

### 方法一：使用图形界面

1. **打开任务计划程序**
   - 按 `Win + R`，输入 `taskschd.msc`
   - 或在开始菜单搜索"任务计划程序"

2. **创建基本任务**
   - 点击右侧"创建基本任务"
   - 名称：`比赛信息爬虫`
   - 描述：`每天早上9点自动爬取所有平台比赛信息`

3. **设置触发器**
   - 选择"每天"
   - 开始时间：`09:00:00`
   - 重复间隔：`1天`

4. **设置操作**
   - 选择"启动程序"
   - 程序或脚本：`E:\pachong\run_crawler_silent.bat`
   - 起始于：`E:\pachong`

5. **完成设置**
   - 勾选"当单击完成时，打开此任务的属性对话框"
   - 在属性中设置：
     - 勾选"不管用户是否登录都要运行"
     - 勾选"使用最高权限运行"

### 方法二：使用命令行

```cmd
# 创建定时任务
schtasks /create /tn "比赛信息爬虫" /tr "E:\pachong\run_crawler_silent.bat" /sc daily /st 09:00 /f

# 查看任务状态
schtasks /query /tn "比赛信息爬虫"

# 立即运行任务（测试）
schtasks /run /tn "比赛信息爬虫"

# 删除任务
schtasks /delete /tn "比赛信息爬虫" /f
```

## 📊 监控和日志

### 日志文件位置
- **详细日志**: `logs/scheduler_YYYYMM.log`
  - 包含每次爬虫执行的详细信息
  - 按月份分割，便于管理
  
- **任务日志**: `logs/task_scheduler.log`
  - 记录任务计划程序的执行情况
  - 包含开始时间、结束时间和执行结果

### 日志内容示例
```
2025-01-28 09:00:01 - INFO - ============================================================
2025-01-28 09:00:01 - INFO - 🚀 开始执行每日爬虫任务 - 2025-01-28 09:00:01
2025-01-28 09:00:01 - INFO - ============================================================
2025-01-28 09:00:01 - INFO - 📍 开始爬取百度AI Studio...
2025-01-28 09:00:15 - INFO - ✅ 百度AI Studio爬取完成
2025-01-28 09:00:20 - INFO - 📍 开始爬取阿里天池...
2025-01-28 09:00:35 - INFO - ✅ 阿里天池爬取完成
2025-01-28 09:00:40 - INFO - 📍 开始爬取腾讯CSDN...
2025-01-28 09:00:55 - INFO - ✅ 腾讯CSDN爬取完成
2025-01-28 09:01:00 - INFO - 📍 开始更新比赛状态...
2025-01-28 09:01:10 - INFO - ✅ 比赛状态更新完成
2025-01-28 09:01:10 - INFO - ============================================================
2025-01-28 09:01:10 - INFO - 📊 任务执行完成 - 2025-01-28 09:01:10
2025-01-28 09:01:10 - INFO - ⏱️ 执行时长: 0:01:09.123456
2025-01-28 09:01:10 - INFO - 📈 成功平台: 3/3
2025-01-28 09:01:10 - INFO - 🎉 所有平台爬取成功！
2025-01-28 09:01:10 - INFO - ============================================================
```

## 🔧 高级配置

### 修改执行时间
如需修改执行时间，有两种方式：

1. **修改Python调度器**（推荐）
   ```python
   # 在scheduler.py中修改这一行
   schedule.every().day.at("09:00").do(run_daily_crawl)
   # 改为其他时间，如下午2点
   schedule.every().day.at("14:00").do(run_daily_crawl)
   ```

2. **修改Windows任务计划**
   - 在任务计划程序中找到任务
   - 右键选择"属性"
   - 在"触发器"标签页中修改时间

### 添加多个执行时间
```python
# 在scheduler.py中添加多个时间点
schedule.every().day.at("09:00").do(run_daily_crawl)
schedule.every().day.at("15:00").do(run_daily_crawl)
schedule.every().day.at("21:00").do(run_daily_crawl)
```

### 自定义爬取平台
如需只爬取特定平台，可以修改 `run_daily_crawl()` 函数，注释掉不需要的平台。

## 🚨 故障排除

### 常见问题

1. **任务不执行**
   - 检查任务计划程序中任务状态
   - 确认批处理文件路径正确
   - 查看 `logs/task_scheduler.log` 日志

2. **Python模块导入失败**
   - 确认已安装所有依赖：`pip install -r requirements.txt`
   - 检查Python环境路径
   - 如使用虚拟环境，需在批处理文件中激活

3. **权限问题**
   - 确保任务以管理员权限运行
   - 检查文件和目录的读写权限

4. **网络连接问题**
   - 检查网络连接
   - 确认防火墙设置
   - 查看详细错误日志

### 调试步骤

1. **手动测试**
   ```bash
   # 测试单次执行
   python scheduler.py --mode once
   ```

2. **检查批处理文件**
   ```cmd
   # 双击运行批处理文件
   run_crawler.bat
   ```

3. **查看日志**
   ```bash
   # 查看最新日志
   tail -f logs/scheduler_202501.log
   ```

## 📞 技术支持

如遇到问题，请：
1. 查看日志文件获取详细错误信息
2. 确认所有依赖已正确安装
3. 检查网络连接和API配置
4. 联系技术支持并提供日志文件

---

**注意**: 请确保在设置定时任务前已正确配置所有API密钥和环境变量。